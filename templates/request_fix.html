<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Request Vulnerability Fix</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>

  <!-- Fixed Bug Image with Fade -->
  <div class="bug-image"></div>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>Secure Your Application</h1>
      <p>Request a verified fix for your detected vulnerability</p>
    </div>
  </section>

  <!-- Form Section -->
  <section class="form-section">
    <h2>Vulnerability Fix Request</h2>

    <form id="fixForm">
      <label>Company Name <span class="required">*</span></label>
      <input type="text" id="companyName" required>

      <label>Website / Application URL <span class="required">*</span></label>
      <input type="url" id="websiteUrl" required>

      <label>Selected Vulnerability <span class="required">*</span></label>
      <select id="vulnerabilityType" multiple required
        style="height: 120px; background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px; width: 100%;">
        <option value="Full Scan">Full Scan (All Detected Bugs)</option>
      </select>
      <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Hold Ctrl (or Cmd) to select multiple.</p>

      <label>Affected Endpoint</label>
      <input type="text" id="affectedEndpoint" placeholder="/login">

      <label>Tech Stack <span class="required">*</span></label>
      <select id="techStack" required>
        <option value="">Select</option>
        <option>PHP</option>
        <option>Node.js</option>
        <option>Django</option>
        <option>Flask</option>
        <option>Other</option>
      </select>

      <label>Contact Email <span class="required">*</span></label>
      <input type="email" id="contactEmail" required>

      <label>WhatsApp Number <span class="required">*</span></label>
      <input type="tel" id="whatsappNumber" placeholder="+91XXXXXXXXXX" required>

      <label class="checkbox">
        <input type="checkbox" id="confirmConsent" required>
        I confirm that I own this application or have permission to test and modify it. <span class="required">*</span>
      </label>

      <button type="submit">Submit Request</button>
    </form>
  </section>

  <!-- Success Modal -->
  <div class="overlay hidden" id="overlay"></div>
  <div class="modal hidden" id="successModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">ðŸŽ‰ Congratulations! ðŸŽ‰</h3>
    <p>You're one step closer to securing your application.</p>
    <button id="closeModal">OK</button>
  </div>

  <script>
    (function () {
      const form = document.getElementById("fixForm");
      const overlay = document.getElementById('overlay');
      const modal = document.getElementById('successModal');
      const closeBtn = document.getElementById('closeModal');
      const submitBtn = form.querySelector('button[type="submit"]');
      const vulnSelect = document.getElementById('vulnerabilityType');

      // Get all form fields (inputs, selects, checkboxes) in order
      const formFields = [
        ...form.querySelectorAll('input[type="text"], input[type="url"], input[type="email"], input[type="tel"], select, input[type="checkbox"]')
      ];

      function showModal() {
        overlay.classList.remove('hidden');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        closeBtn.focus();
      }

      function hideModal() {
        overlay.classList.add('hidden');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        form.reset();
      }

      function collectFormData() {
        const selectedVulns = Array.from(vulnSelect.selectedOptions).map(opt => opt.value);
        return {
          company_name: document.getElementById('companyName').value,
          website_url: document.getElementById('websiteUrl').value,
          vulnerability: selectedVulns.join(', '),
          endpoint: document.getElementById('affectedEndpoint').value,
          tech_stack: document.getElementById('techStack').value,
          contact_email: document.getElementById('contactEmail').value,
          whatsapp_number: document.getElementById('whatsappNumber').value
        };
      }

      // Auto-fill from query parameters and localStorage
      function autoFill() {
        const params = new URLSearchParams(window.location.search);
        const queryVuln = params.get('vulnerability');
        const queryEndpoint = params.get('endpoint');

        // Load from localStorage
        const stored = localStorage.getItem('lastScanResults');
        if (stored) {
          try {
            const data = JSON.parse(stored);
            if (data.vulnerabilities && data.vulnerabilities.length > 0) {
              // Populate dropdown with unique vulnerabilities
              const uniqueVulns = [...new Set(data.vulnerabilities.map(v => v.vulnerability_type))];
              uniqueVulns.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                vulnSelect.appendChild(opt);
              });

              if (!document.getElementById('websiteUrl').value && data.url) {
                document.getElementById('websiteUrl').value = data.url;
              }
            }
          } catch (e) {
            console.error("Error parsing stored results", e);
          }
        }

        // Handle specific selection from "Fix It" button
        if (queryVuln) {
          // Check if it exists in options, if not add it
          let found = false;
          Array.from(vulnSelect.options).forEach(opt => {
            if (opt.value === queryVuln) {
              opt.selected = true;
              found = true;
            }
          });
          if (!found) {
            const opt = document.createElement('option');
            opt.value = queryVuln;
            opt.textContent = queryVuln;
            opt.selected = true;
            vulnSelect.appendChild(opt);
          }
        } else {
          // Default to Full Scan if nothing specified
          vulnSelect.options[0].selected = true;
        }

        if (queryEndpoint) {
          document.getElementById('affectedEndpoint').value = queryEndpoint;
          try {
            const url = new URL(queryEndpoint);
            document.getElementById('websiteUrl').value = url.origin;
          } catch (e) { }
        }
      }

      autoFill();

      // Handle Enter key to navigate between fields
      formFields.forEach((field, index) => {
        field.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();

            // If this is the last field, submit the form
            if (index === formFields.length - 1) {
              form.dispatchEvent(new Event('submit'));
            } else {
              // Move to next field
              const nextField = formFields[index + 1];
              nextField.focus();
              if (nextField.type === 'text' || nextField.type === 'url' || nextField.type === 'email' || nextField.type === 'tel') {
                nextField.select();
              }
            }
          }
        });
      });

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        const data = collectFormData();

        fetch('/submit-form', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(res => res.json())
          .then(result => {
            showModal();
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Request';
          })
          .catch(err => {
            console.error('Error:', err);
            alert('Error submitting form. Check console.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Request';
          });
      });

      closeBtn.addEventListener('click', hideModal);
      overlay.addEventListener('click', hideModal);

      // keyboard: close on Escape
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
          hideModal();
        }
      });
    })();
  </script>

</body>

</html>